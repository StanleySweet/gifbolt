From 97f6fd62b58b87b63c23621973ab9636ab678f90 Mon Sep 17 00:00:00 2001
From: Stanislas Daniel Claude Dolcini <stanislas.dolcini@gmail.com>
Date: Mon, 19 Jan 2026 21:25:24 +0100
Subject: [PATCH 06/11] refactor: Extract common animation logic to
 GifAnimationControllerBase in Core

- Create GifAnimationControllerBase in GifBolt.Core with shared logic
- WPF and Avalonia controllers now inherit and override only timer-specific code
- Eliminates 100+ lines of duplicated frame advancement, repeat handling, Play/Pause/Stop
- Single source of truth for animation state management and frame sequencing
- Both platforms still handle their own pixel copy mechanisms (WritePixels vs Lock)
- Reduces maintenance burden and ensures API consistency across platforms
---
 .../GifAnimationController.cs                 |  72 +++---------
 .../GifAnimationControllerBase.cs             | 111 ++++++++++++++++++
 src/GifBolt.Wpf/AnimationBehavior.cs          |  42 +++----
 src/GifBolt.Wpf/GifAnimationController.cs     |  98 +++-------------
 4 files changed, 163 insertions(+), 160 deletions(-)
 create mode 100644 src/GifBolt.Core/GifAnimationControllerBase.cs

diff --git a/src/GifBolt.Avalonia/GifAnimationController.cs b/src/GifBolt.Avalonia/GifAnimationController.cs
index c0c4f30..68cbe0c 100644
--- a/src/GifBolt.Avalonia/GifAnimationController.cs
+++ b/src/GifBolt.Avalonia/GifAnimationController.cs
@@ -15,16 +15,12 @@ using Avalonia.Threading;
 namespace GifBolt.Avalonia
 {
     /// <summary>
-    /// Manages animation state and frame rendering for a GIF displayed in an Image control.
-    /// Handles frame decoding, timing, and pixel updates to the display.
+    /// Avalonia-specific GIF animation controller using DispatcherTimer for frame timing.
     /// </summary>
-    internal sealed class GifAnimationController : IDisposable
+    internal sealed class GifAnimationController : GifAnimationControllerBase
     {
         private readonly Image _image;
-        private readonly GifBolt.GifPlayer _player;
-        private WriteableBitmap _writeableBitmap;
-        private bool _isPlaying;
-        private int _repeatCount;
+        private readonly WriteableBitmap _writeableBitmap;
         private DispatcherTimer _animationTimer;

         /// <summary>
@@ -34,18 +30,12 @@ namespace GifBolt.Avalonia
         /// <param name="path">The file path to the GIF image.</param>
         /// <exception cref="InvalidOperationException">Thrown if the GIF cannot be loaded.</exception>
         public GifAnimationController(Image image, string path)
+            : base(path)
         {
             this._image = image;
-            this._player = new GifBolt.GifPlayer();
-
-            if (!this._player.Load(path))
-            {
-                this._player.Dispose();
-                throw new InvalidOperationException($"Failed to load GIF: {path}");
-            }

             this._writeableBitmap = new WriteableBitmap(
-                new PixelSize(this._player.Width, this._player.Height),
+                new PixelSize(this.Player.Width, this.Player.Height),
                 new Vector(96, 96),
                 PixelFormat.Bgra8888);

@@ -60,63 +50,51 @@ namespace GifBolt.Avalonia
         /// <summary>
         /// Starts playback of the animation.
         /// </summary>
-        public void Play()
+        public override void Play()
         {
-            this._player.Play();
-            this._isPlaying = true;
+            base.Play();
             this._animationTimer.Start();
         }

         /// <summary>
         /// Pauses playback of the animation.
         /// </summary>
-        public void Pause()
+        public override void Pause()
         {
-            this._player.Pause();
-            this._isPlaying = false;
+            base.Pause();
             this._animationTimer.Stop();
         }

         /// <summary>
         /// Stops playback and resets to the first frame.
         /// </summary>
-        public void Stop()
+        public override void Stop()
         {
-            this._player.Stop();
-            this._isPlaying = false;
+            base.Stop();
             this._animationTimer.Stop();
         }

-        /// <summary>
-        /// Sets the repeat behavior for the animation.
-        /// </summary>
-        /// <param name="repeatBehavior">The repeat behavior string ("Forever", "3x", "0x", etc.).</param>
-        public void SetRepeatBehavior(string repeatBehavior)
-        {
-            this._repeatCount = RepeatBehaviorHelper.ComputeRepeatCount(repeatBehavior, this._player.IsLooping);
-        }
-
         /// <summary>
         /// Releases all resources held by the animation controller.
         /// </summary>
-        public void Dispose()
+        public override void Dispose()
         {
             this._animationTimer?.Stop();
             this._animationTimer = null;
-            this._player?.Dispose();
+            base.Dispose();
         }

         private void OnTimerTick(object? sender, EventArgs e)
         {
-            if (!this._isPlaying)
+            if (!this.IsPlaying)
             {
                 return;
             }

-            if (this._player.TryGetFramePixelsBgra32Premultiplied(this._player.CurrentFrame, out byte[] pixels))
+            if (this.Player.TryGetFramePixelsBgra32Premultiplied(this.Player.CurrentFrame, out byte[] pixels))
             {
-                int width = this._player.Width;
-                int height = this._player.Height;
+                int width = this.Player.Width;
+                int height = this.Player.Height;

                 using (var frameBuffer = this._writeableBitmap.Lock())
                 {
@@ -127,21 +105,7 @@ namespace GifBolt.Avalonia
                 this._image.InvalidateVisual();
             }

-            // Advance to the next frame using shared helper
-            var advanceResult = FrameAdvanceHelper.AdvanceFrame(
-                this._player.CurrentFrame,
-                this._player.FrameCount,
-                this._repeatCount);
-
-            if (advanceResult.IsComplete)
-            {
-                this.Stop();
-                return;
-            }
-
-            // Update the current frame and repeat count
-            this._player.CurrentFrame = advanceResult.NextFrame;
-            this._repeatCount = advanceResult.UpdatedRepeatCount;
+            this.AdvanceFrame();
         }
     }
 }
diff --git a/src/GifBolt.Core/GifAnimationControllerBase.cs b/src/GifBolt.Core/GifAnimationControllerBase.cs
new file mode 100644
index 0000000..8fde201
--- /dev/null
+++ b/src/GifBolt.Core/GifAnimationControllerBase.cs
@@ -0,0 +1,111 @@
+// <copyright file="GifAnimationControllerBase.cs" company="GifBolt Contributors">
+// Copyright (c) 2026 GifBolt Contributors. All rights reserved.
+// Licensed under the MIT License. See LICENSE file in the project root for full license information.
+// </copyright>
+// SPDX-License-Identifier: MIT
+// SPDX-FileCopyrightText: 2026 GifBolt Contributors
+
+using System;
+
+namespace GifBolt
+{
+    /// <summary>
+    /// Base class for platform-specific GIF animation controllers.
+    /// Provides common animation logic that is independent of the UI framework.
+    /// </summary>
+    public abstract class GifAnimationControllerBase : IDisposable
+    {
+        /// <summary>Gets the GIF player instance.</summary>
+        protected GifPlayer Player { get; }
+
+        /// <summary>Gets or sets a value indicating whether animation is playing.</summary>
+        protected bool IsPlaying { get; set; }
+
+        /// <summary>Gets or sets the repeat count.</summary>
+        protected int RepeatCount { get; set; }
+
+        /// <summary>
+        /// Initializes a new instance of the <see cref="GifAnimationControllerBase"/> class.
+        /// </summary>
+        /// <param name="path">The file path to the GIF image.</param>
+        /// <exception cref="InvalidOperationException">Thrown if the GIF cannot be loaded.</exception>
+        protected GifAnimationControllerBase(string path)
+        {
+            this.Player = new GifPlayer();
+
+            if (!this.Player.Load(path))
+            {
+                this.Player.Dispose();
+                throw new InvalidOperationException($"Failed to load GIF: {path}");
+            }
+        }
+
+        /// <summary>
+        /// Starts playback of the animation.
+        /// </summary>
+        public virtual void Play()
+        {
+            this.Player.Play();
+            this.IsPlaying = true;
+        }
+
+        /// <summary>
+        /// Pauses playback of the animation.
+        /// </summary>
+        public virtual void Pause()
+        {
+            this.Player.Pause();
+            this.IsPlaying = false;
+        }
+
+        /// <summary>
+        /// Stops playback and resets to the first frame.
+        /// </summary>
+        public virtual void Stop()
+        {
+            this.Player.Stop();
+            this.IsPlaying = false;
+        }
+
+        /// <summary>
+        /// Sets the repeat behavior for the animation.
+        /// </summary>
+        /// <param name="repeatBehavior">The repeat behavior string ("Forever", "3x", "0x", etc.).</param>
+        public virtual void SetRepeatBehavior(string repeatBehavior)
+        {
+            this.RepeatCount = RepeatBehaviorHelper.ComputeRepeatCount(repeatBehavior, this.Player.IsLooping);
+        }
+
+        /// <summary>
+        /// Advances the animation to the next frame and handles repeat logic.
+        /// Call this from your platform-specific timer tick handler after rendering.
+        /// </summary>
+        /// <returns>true if animation should continue; false if animation is complete.</returns>
+        protected bool AdvanceFrame()
+        {
+            var advanceResult = FrameAdvanceHelper.AdvanceFrame(
+                this.Player.CurrentFrame,
+                this.Player.FrameCount,
+                this.RepeatCount);
+
+            if (advanceResult.IsComplete)
+            {
+                this.Stop();
+                return false;
+            }
+
+            this.Player.CurrentFrame = advanceResult.NextFrame;
+            this.RepeatCount = advanceResult.UpdatedRepeatCount;
+            return true;
+        }
+
+        /// <summary>
+        /// Releases all resources held by the animation controller.
+        /// </summary>
+        public virtual void Dispose()
+        {
+            this.Player?.Dispose();
+            GC.SuppressFinalize(this);
+        }
+    }
+}
diff --git a/src/GifBolt.Wpf/AnimationBehavior.cs b/src/GifBolt.Wpf/AnimationBehavior.cs
index fdc3942..81b802f 100644
--- a/src/GifBolt.Wpf/AnimationBehavior.cs
+++ b/src/GifBolt.Wpf/AnimationBehavior.cs
@@ -230,34 +230,22 @@ namespace GifBolt.Wpf

             // Create new animation controller
             var repeatBehavior = GetRepeatBehavior(image);
-            var controller = new GifAnimationController(image, resolvedPath,
-                onLoaded: () =>
-                {
-                    // Verify controller is still current
-                    var current = GetAnimationController(image);
-                    if (current == null)
-                    {
-                        return;
-                    }
-
-                    // Apply repeat behavior
-                    current.SetRepeatBehavior(repeatBehavior);
-
-                    // Auto-start (default for XamlAnimatedGif compatibility)
-                    try
-                    {
-                        current.Play();
-                    }
-                    catch
-                    {
-                        // Suppress errors during autostart
-                    }
-                },
-                onError: (ex) =>
-                {
-                    System.Diagnostics.Debug.WriteLine($"[GifBolt] Error loading GIF '{sourceUri}': {ex.Message}");
-                });
+            var controller = new GifAnimationController(image, resolvedPath);
+
+            // Apply repeat behavior
+            controller.SetRepeatBehavior(repeatBehavior);
+
+            // Auto-start (default for XamlAnimatedGif compatibility)
+            try
+            {
+                controller.Play();
+            }
+            catch
+            {
+                // Suppress errors during autostart
+            }

+            // Store the controller
             SetAnimationController(image, controller);
             image.Unloaded += OnImageUnloaded;
         }
diff --git a/src/GifBolt.Wpf/GifAnimationController.cs b/src/GifBolt.Wpf/GifAnimationController.cs
index 1975006..090328a 100644
--- a/src/GifBolt.Wpf/GifAnimationController.cs
+++ b/src/GifBolt.Wpf/GifAnimationController.cs
@@ -14,16 +14,12 @@ using System.Windows.Media.Imaging;
 namespace GifBolt.Wpf
 {
     /// <summary>
-    /// Manages animation state and frame rendering for a GIF displayed in an Image control.
-    /// Handles frame decoding, timing, and pixel updates to the display.
+    /// WPF-specific GIF animation controller using CompositionTarget.Rendering for frame timing.
     /// </summary>
-    internal sealed class GifAnimationController : IDisposable
+    internal sealed class GifAnimationController : GifAnimationControllerBase
     {
         private readonly Image _image;
-        private readonly GifBolt.GifPlayer _player;
-        private WriteableBitmap _writeableBitmap;
-        private bool _isPlaying;
-        private int _repeatCount;
+        private readonly WriteableBitmap _writeableBitmap;

         /// <summary>
         /// Initializes a new instance of the <see cref="GifAnimationController"/> class.
@@ -32,19 +28,13 @@ namespace GifBolt.Wpf
         /// <param name="path">The file path to the GIF image.</param>
         /// <exception cref="InvalidOperationException">Thrown if the GIF cannot be loaded.</exception>
         public GifAnimationController(Image image, string path)
+            : base(path)
         {
             this._image = image;
-            this._player = new GifBolt.GifPlayer();
-
-            if (!this._player.Load(path))
-            {
-                this._player.Dispose();
-                throw new InvalidOperationException($"Failed to load GIF: {path}");
-            }

             this._writeableBitmap = new WriteableBitmap(
-                this._player.Width,
-                this._player.Height,
+                this.Player.Width,
+                this.Player.Height,
                 96,
                 96,
                 PixelFormats.Bgra32,
@@ -55,62 +45,17 @@ namespace GifBolt.Wpf
             CompositionTarget.Rendering += this.OnRendering;
         }

-        /// <summary>
-        /// Starts playback of the animation.
-        /// </summary>
-        public void Play()
-        {
-            this._player.Play();
-            this._isPlaying = true;
-        }
-
-        /// <summary>
-        /// Pauses playback of the animation.
-        /// </summary>
-        public void Pause()
-        {
-            this._player.Pause();
-            this._isPlaying = false;
-        }
-
-        /// <summary>
-        /// Stops playback and resets to the first frame.
-        /// </summary>
-        public void Stop()
-        {
-            this._player.Stop();
-            this._isPlaying = false;
-        }
-
-        /// <summary>
-        /// Sets the repeat behavior for the animation.
-        /// </summary>
-        /// <param name="repeatBehavior">The repeat behavior string ("Forever", "3x", "0x", etc.).</param>
-        public void SetRepeatBehavior(string repeatBehavior)
-        {
-            this._repeatCount = RepeatBehaviorHelper.ComputeRepeatCount(repeatBehavior, this._player.IsLooping);
-        }
-
-        /// <summary>
-        /// Releases all resources held by the animation controller.
-        /// </summary>
-        public void Dispose()
-        {
-            CompositionTarget.Rendering -= this.OnRendering;
-            this._player?.Dispose();
-        }
-
         private void OnRendering(object sender, EventArgs e)
         {
-            if (!this._isPlaying)
+            if (!this.IsPlaying)
             {
                 return;
             }

-            if (this._player.TryGetFramePixelsBgra32Premultiplied(this._player.CurrentFrame, out byte[] pixels))
+            if (this.Player.TryGetFramePixelsBgra32Premultiplied(this.Player.CurrentFrame, out byte[] pixels))
             {
-                int width = this._player.Width;
-                int height = this._player.Height;
+                int width = this.Player.Width;
+                int height = this.Player.Height;
                 int stride = width * 4;

                 this._writeableBitmap.WritePixels(
@@ -120,21 +65,16 @@ namespace GifBolt.Wpf
                     0);
             }

-            // Advance to the next frame using shared helper
-            var advanceResult = FrameAdvanceHelper.AdvanceFrame(
-                this._player.CurrentFrame,
-                this._player.FrameCount,
-                this._repeatCount);
-
-            if (advanceResult.IsComplete)
-            {
-                this.Stop();
-                return;
-            }
+            this.AdvanceFrame();
+        }

-            // Update the current frame and repeat count
-            this._player.CurrentFrame = advanceResult.NextFrame;
-            this._repeatCount = advanceResult.UpdatedRepeatCount;
+        /// <summary>
+        /// Releases all resources held by the animation controller.
+        /// </summary>
+        public override void Dispose()
+        {
+            CompositionTarget.Rendering -= this.OnRendering;
+            base.Dispose();
         }
     }
 }
--
2.49.0
