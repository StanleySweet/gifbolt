From 3ce3d1a5fcf779956a8bacd87e8abe9d848adef3 Mon Sep 17 00:00:00 2001
From: Stanislas Daniel Claude Dolcini <stanislas.dolcini@gmail.com>
Date: Mon, 19 Jan 2026 22:01:57 +0100
Subject: [PATCH 09/11] fix: Synchronize frame advancement with actual frame
 delays

- Track elapsed time per frame instead of advancing on every timer tick
- Only advance frame when its delay requirement is satisfied
- Prevents frame skipping and ensures correct timing for 100ms minimum delay
- Applied to both WPF and Avalonia controllers
---
 .../Views/MainWindow.axaml                    |  1 +
 .../Views/MainWindow.axaml.cs                 |  1 +
 .../GifAnimationController.cs                 | 24 +++++++++++++++++--
 .../GifAnimationControllerBase.cs             |  1 +
 src/GifBolt.Wpf/GifAnimationController.cs     | 21 ++++++++++++++--
 5 files changed, 44 insertions(+), 4 deletions(-)

diff --git a/samples/GifBolt.AvaloniaApp/Views/MainWindow.axaml b/samples/GifBolt.AvaloniaApp/Views/MainWindow.axaml
index 5d2e982..b8f3f22 100644
--- a/samples/GifBolt.AvaloniaApp/Views/MainWindow.axaml
+++ b/samples/GifBolt.AvaloniaApp/Views/MainWindow.axaml
@@ -26,4 +26,5 @@
                 <Button Content="Load GIF..." Width="100" Margin="5" Click="OnLoadGif"/>
             </StackPanel>
         </StackPanel>
+    </Grid>
 </Window>
diff --git a/samples/GifBolt.AvaloniaApp/Views/MainWindow.axaml.cs b/samples/GifBolt.AvaloniaApp/Views/MainWindow.axaml.cs
index 1d383ce..477467f 100644
--- a/samples/GifBolt.AvaloniaApp/Views/MainWindow.axaml.cs
+++ b/samples/GifBolt.AvaloniaApp/Views/MainWindow.axaml.cs
@@ -5,6 +5,7 @@ using System;
 using System.Collections.Generic;
 using Avalonia.Controls;
 using Avalonia.Interactivity;
+using GifBolt.Avalonia;

 namespace GifBolt.AvaloniaApp.Views;

diff --git a/src/GifBolt.Avalonia/GifAnimationController.cs b/src/GifBolt.Avalonia/GifAnimationController.cs
index 1cf996d..60cb8ef 100644
--- a/src/GifBolt.Avalonia/GifAnimationController.cs
+++ b/src/GifBolt.Avalonia/GifAnimationController.cs
@@ -22,6 +22,8 @@ namespace GifBolt.Avalonia
         private readonly Image _image;
         private readonly WriteableBitmap _writeableBitmap;
         private DispatcherTimer _animationTimer;
+        private DateTime _frameStartTime;
+        private int _lastDisplayedFrame;

         /// <summary>
         /// Initializes a new instance of the <see cref="GifAnimationController"/> class.
@@ -53,6 +55,8 @@ namespace GifBolt.Avalonia
         public override void Play()
         {
             base.Play();
+            this._frameStartTime = DateTime.UtcNow;
+            this._lastDisplayedFrame = this.Player.CurrentFrame;
             this._animationTimer.Start();
         }

@@ -91,6 +95,24 @@ namespace GifBolt.Avalonia
                 return;
             }

+            // Get the frame delay for the current frame (respects the 100ms minimum set in base constructor)
+            int frameDelayMs = this.Player.GetFrameDelayMs(this.Player.CurrentFrame);
+            long elapsedMs = (long)(DateTime.UtcNow - this._frameStartTime).TotalMilliseconds;
+
+            // Only advance frame if enough time has elapsed for the current frame
+            if (elapsedMs >= frameDelayMs)
+            {
+                // Advance to next frame and reset the frame start time
+                if (!this.AdvanceFrame())
+                {
+                    // Animation complete
+                    return;
+                }
+
+                this._frameStartTime = DateTime.UtcNow;
+            }
+
+            // Render the current frame
             if (this.Player.TryGetFramePixelsBgra32Premultiplied(this.Player.CurrentFrame, out byte[] pixels))
             {
                 int width = this.Player.Width;
@@ -104,8 +126,6 @@ namespace GifBolt.Avalonia
                 // Invalidate the bitmap to trigger redraw in Avalonia
                 this._image.InvalidateVisual();
             }
-
-            this.AdvanceFrame();
         }
     }
 }
diff --git a/src/GifBolt.Core/GifAnimationControllerBase.cs b/src/GifBolt.Core/GifAnimationControllerBase.cs
index be6efc6..a39e8f6 100644
--- a/src/GifBolt.Core/GifAnimationControllerBase.cs
+++ b/src/GifBolt.Core/GifAnimationControllerBase.cs
@@ -51,6 +51,7 @@ namespace GifBolt
         {
             this.Player.Play();
             this.IsPlaying = true;
+            this.Player.CurrentFrame = 0;
         }

         /// <summary>
diff --git a/src/GifBolt.Wpf/GifAnimationController.cs b/src/GifBolt.Wpf/GifAnimationController.cs
index ccbb6c7..526507a 100644
--- a/src/GifBolt.Wpf/GifAnimationController.cs
+++ b/src/GifBolt.Wpf/GifAnimationController.cs
@@ -20,6 +20,7 @@ namespace GifBolt.Wpf
     {
         private readonly Image _image;
         private readonly WriteableBitmap _writeableBitmap;
+        private DateTime _frameStartTime;

         /// <summary>
         /// Initializes a new instance of the <see cref="GifAnimationController"/> class.
@@ -52,6 +53,24 @@ namespace GifBolt.Wpf
                 return;
             }

+            // Get the frame delay for the current frame (respects the 100ms minimum set in base constructor)
+            int frameDelayMs = this.Player.GetFrameDelayMs(this.Player.CurrentFrame);
+            long elapsedMs = (long)(DateTime.UtcNow - this._frameStartTime).TotalMilliseconds;
+
+            // Only advance frame if enough time has elapsed for the current frame
+            if (elapsedMs >= frameDelayMs)
+            {
+                // Advance to next frame and reset the frame start time
+                if (!this.AdvanceFrame())
+                {
+                    // Animation complete
+                    return;
+                }
+
+                this._frameStartTime = DateTime.UtcNow;
+            }
+
+            // Render the current frame
             if (this.Player.TryGetFramePixelsBgra32Premultiplied(this.Player.CurrentFrame, out byte[] pixels))
             {
                 int width = this.Player.Width;
@@ -64,8 +83,6 @@ namespace GifBolt.Wpf
                     stride,
                     0);
             }
-
-            this.AdvanceFrame();
         }

         /// <summary>
--
2.49.0
