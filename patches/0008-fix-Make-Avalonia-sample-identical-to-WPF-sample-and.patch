From 8ca5d783b0cda259d898457c56db315e5b72660b Mon Sep 17 00:00:00 2001
From: Stanislas Daniel Claude Dolcini <stanislas.dolcini@gmail.com>
Date: Mon, 19 Jan 2026 21:37:38 +0100
Subject: [PATCH 08/11] fix: Make Avalonia sample identical to WPF sample and
 restore 100ms min delay

- Simplify Avalonia MainWindow.axaml to exactly match WPF layout and structure
- Update code-behind to use AnimationBehavior.SetSourceUri (identical pattern to WPF)
- Remove complex UI elements and interactive controls
- Restore 100ms minimum frame delay in GifAnimationControllerBase constructor
- Both samples now identical in functionality and appearance
---
 .../Views/MainWindow.axaml                    | 104 ++++--------------
 .../Views/MainWindow.axaml.cs                 |  75 ++-----------
 .../GifAnimationControllerBase.cs             |   4 +
 3 files changed, 33 insertions(+), 150 deletions(-)

diff --git a/samples/GifBolt.AvaloniaApp/Views/MainWindow.axaml b/samples/GifBolt.AvaloniaApp/Views/MainWindow.axaml
index ef7f12c..5d2e982 100644
--- a/samples/GifBolt.AvaloniaApp/Views/MainWindow.axaml
+++ b/samples/GifBolt.AvaloniaApp/Views/MainWindow.axaml
@@ -1,93 +1,29 @@
 <Window xmlns="https://github.com/avaloniaui"
         xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
-        xmlns:vm="using:GifBolt.AvaloniaApp.ViewModels"
         xmlns:gif="using:GifBolt.Avalonia"
-        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
-        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
-        mc:Ignorable="d" d:DesignWidth="800" d:DesignHeight="600"
         x:Class="GifBolt.AvaloniaApp.Views.MainWindow"
-        x:DataType="vm:MainWindowViewModel"
         Icon="/Assets/avalonia-logo.ico"
-        Title="GifBolt Avalonia Sample">
-
-    <Design.DataContext>
-        <vm:MainWindowViewModel/>
-    </Design.DataContext>
-
-    <Grid RowDefinitions="Auto,*,Auto" Margin="20">
-        <!-- Header -->
-        <StackPanel Grid.Row="0" Spacing="10" Margin="0,0,0,20">
-            <TextBlock Text="GifBolt - Avalonia Sample" FontSize="24" FontWeight="Bold" HorizontalAlignment="Center"/>
-            <TextBlock Text="XamlAnimatedGif-compatible GIF animation with GPU acceleration"
-                       HorizontalAlignment="Center" Foreground="Gray"/>
-        </StackPanel>
-
-        <!-- Main Content -->
-        <StackPanel Grid.Row="1" Spacing="20">
-            <!-- Quick Load Example -->
-            <StackPanel Spacing="10">
-                <TextBlock Text="Load a GIF file to see it in action" FontSize="14" FontWeight="Bold"/>
-                <StackPanel Orientation="Horizontal" Spacing="10">
-                    <Button x:Name="LoadButton" Content="Load GIF..." Padding="10,5" Click="OnLoadGif"/>
-                    <TextBlock x:Name="FileLabel" VerticalAlignment="Center" Foreground="Gray" Text="(No file selected)"/>
-                </StackPanel>
-            </StackPanel>
-
-            <!-- Animation Display -->
-            <Border BorderBrush="Gray" BorderThickness="1" Padding="10" Background="#F5F5F5">
-                <Grid>
-                    <Image x:Name="AnimatedImage"
-                           gif:AnimationBehavior.RepeatBehavior="Forever"
-                           Stretch="Uniform"
-                           MaxHeight="300"
-                           HorizontalAlignment="Center"
-                           VerticalAlignment="Center"/>
-                    <TextBlock Text="Load a GIF file using the button above"
-                               HorizontalAlignment="Center"
-                               VerticalAlignment="Center"
-                               Foreground="Gray"
-                               x:Name="EmptyPlaceholder"/>
-                </Grid>
-            </Border>
+        Title="GifBolt Avalonia Sample"
+        Height="600"
+        Width="800">
+
+    <Grid RowDefinitions="Auto,*,Auto">
+        <TextBlock Grid.Row="0" Margin="10" FontSize="16" FontWeight="Bold">
+            GifBolt - Animated GIF Viewer (XamlAnimatedGif Compatible)
+        </TextBlock>
+
+        <Border Grid.Row="1" Margin="10" BorderBrush="Gray" BorderThickness="1">
+            <Image x:Name="AnimatedImage"
+                   gif:AnimationBehavior.RepeatBehavior="Forever"
+                   gif:AnimationBehavior.AnimateInDesignMode="False"
+                   Stretch="Uniform"
+                   HorizontalAlignment="Stretch"
+                   VerticalAlignment="Stretch"/>
+        </Border>

-            <!-- Controls -->
-            <StackPanel Spacing="10">
-                <TextBlock Text="Animation Controls" FontSize="12" FontWeight="Bold"/>
-                <StackPanel Orientation="Horizontal" Spacing="10">
-                    <Button x:Name="PlayButton" Content="Play" Padding="10,5" IsEnabled="False"/>
-                    <Button x:Name="PauseButton" Content="Pause" Padding="10,5" IsEnabled="False"/>
-                    <Button x:Name="StopButton" Content="Stop" Padding="10,5" IsEnabled="False"/>
-                </StackPanel>
-                <StackPanel Spacing="5">
-                    <TextBlock Text="Repeat Behavior:" FontSize="11"/>
-                    <ComboBox x:Name="RepeatCombo" SelectedIndex="0">
-                        <ComboBoxItem>Forever</ComboBoxItem>
-                        <ComboBoxItem>1x (Play Once)</ComboBoxItem>
-                        <ComboBoxItem>3x (Repeat 3 times)</ComboBoxItem>
-                    </ComboBox>
-                </StackPanel>
+        <StackPanel Grid.Row="2" Orientation="Vertical" Margin="10">
+            <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
+                <Button Content="Load GIF..." Width="100" Margin="5" Click="OnLoadGif"/>
             </StackPanel>
-
-            <!-- API Documentation -->
-            <Border BorderBrush="Blue" BorderThickness="2" CornerRadius="5"
-                    Padding="15" Background="#E3F2FD">
-                <StackPanel Spacing="8">
-                    <TextBlock Text="âœ¨ XamlAnimatedGif Compatible API" FontWeight="Bold" Foreground="DarkBlue"/>
-                    <TextBlock TextWrapping="Wrap" Text="Use AnimationBehavior attached properties on any standard Image control:"/>
-                    <TextBlock FontFamily="Consolas,Courier New" Foreground="DarkBlue" TextWrapping="Wrap">
-                        &lt;Image gif:AnimationBehavior.SourceUri="file.gif"
-                    </TextBlock>
-                    <TextBlock FontFamily="Consolas,Courier New" Foreground="DarkBlue" Margin="20,0,0,0" TextWrapping="Wrap">
-                        gif:AnimationBehavior.RepeatBehavior="Forever"/&gt;
-                    </TextBlock>
-                </StackPanel>
-            </Border>
         </StackPanel>
-
-        <!-- Status Bar -->
-        <Border Grid.Row="2" BorderBrush="Gray" BorderThickness="0,1,0,0" Padding="10" Margin="0,20,0,0">
-            <TextBlock x:Name="StatusText" Text="Ready" Foreground="Gray" FontSize="11"/>
-        </Border>
-    </Grid>
-
 </Window>
diff --git a/samples/GifBolt.AvaloniaApp/Views/MainWindow.axaml.cs b/samples/GifBolt.AvaloniaApp/Views/MainWindow.axaml.cs
index 9e9b547..1d383ce 100644
--- a/samples/GifBolt.AvaloniaApp/Views/MainWindow.axaml.cs
+++ b/samples/GifBolt.AvaloniaApp/Views/MainWindow.axaml.cs
@@ -5,17 +5,15 @@ using System;
 using System.Collections.Generic;
 using Avalonia.Controls;
 using Avalonia.Interactivity;
-using GifBolt;

 namespace GifBolt.AvaloniaApp.Views;

 /// <summary>
-/// Main window for the GifBolt Avalonia sample application.
-/// Demonstrates AnimationBehavior usage with standard Image controls.
+/// Main window showcasing AnimationBehavior.
 /// </summary>
-public partial class MainWindow : Window
+public sealed partial class MainWindow : Window
 {
-    private GifBolt.Avalonia.GifAnimationController? _currentController;
+    private Image? _imageControl;

     /// <summary>
     /// Initializes a new instance of the <see cref="MainWindow"/> class.
@@ -23,17 +21,12 @@ public partial class MainWindow : Window
     public MainWindow()
     {
         this.InitializeComponent();
-        this.Opened += this.OnWindowOpened;
+        this.Loaded += this.OnWindowLoaded;
     }

-    private void OnWindowOpened(object? sender, EventArgs e)
+    private void OnWindowLoaded(object? sender, RoutedEventArgs e)
     {
-        // Update status
-        var statusText = this.FindControl<TextBlock>("StatusText");
-        if (statusText != null)
-        {
-            statusText.Text = "Ready - click Load GIF to begin";
-        }
+        this._imageControl = this.FindControl<Image>("AnimatedImage");
     }

     /// <summary>
@@ -44,6 +37,7 @@ public partial class MainWindow : Window
         var dialog = new OpenFileDialog
         {
             AllowMultiple = false,
+            Title = "Select a GIF file",
             Filters = new List<FileDialogFilter>
             {
                 new() { Name = "GIF Files", Extensions = new List<string> { "gif" } },
@@ -52,60 +46,9 @@ public partial class MainWindow : Window
         };

         var result = await dialog.ShowAsync(this);
-        if (result?.Length > 0)
+        if (result?.Length > 0 && this._imageControl != null)
         {
-            try
-            {
-                // Clean up old controller
-                this._currentController?.Dispose();
-
-                // Get the image control
-                var image = this.FindControl<Image>("AnimatedImage");
-                var emptyText = this.FindControl<TextBlock>("EmptyPlaceholder");
-                var statusText = this.FindControl<TextBlock>("StatusText");
-                var repeatCombo = this.FindControl<ComboBox>("RepeatCombo");
-
-                if (image != null)
-                {
-                    // Create new animation controller
-                    this._currentController = new GifBolt.Avalonia.GifAnimationController(image, result[0]);
-
-                    // Apply repeat behavior
-                    var repeatBehavior = repeatCombo?.SelectedIndex switch
-                    {
-                        1 => "1x",
-                        2 => "3x",
-                        _ => "Forever"
-                    };
-                    this._currentController.SetRepeatBehavior(repeatBehavior);
-
-                    // Auto-start
-                    this._currentController.Play();
-
-                    // Update UI
-                    if (emptyText != null)
-                        emptyText.IsVisible = false;
-
-                    var fileName = System.IO.Path.GetFileName(result[0]);
-                    if (statusText != null)
-                        statusText.Text = $"Loaded: {fileName}";
-
-                    // Enable controls
-                    var playBtn = this.FindControl<Button>("PlayButton");
-                    var pauseBtn = this.FindControl<Button>("PauseButton");
-                    var stopBtn = this.FindControl<Button>("StopButton");
-
-                    if (playBtn != null) playBtn.IsEnabled = true;
-                    if (pauseBtn != null) pauseBtn.IsEnabled = true;
-                    if (stopBtn != null) stopBtn.IsEnabled = true;
-                }
-            }
-            catch (Exception ex)
-            {
-                var statusText = this.FindControl<TextBlock>("StatusText");
-                if (statusText != null)
-                    statusText.Text = $"Error: {ex.Message}";
-            }
+            AnimationBehavior.SetSourceUri(this._imageControl, result[0]);
         }
     }
 }
diff --git a/src/GifBolt.Core/GifAnimationControllerBase.cs b/src/GifBolt.Core/GifAnimationControllerBase.cs
index 8fde201..be6efc6 100644
--- a/src/GifBolt.Core/GifAnimationControllerBase.cs
+++ b/src/GifBolt.Core/GifAnimationControllerBase.cs
@@ -38,6 +38,10 @@ namespace GifBolt
                 this.Player.Dispose();
                 throw new InvalidOperationException($"Failed to load GIF: {path}");
             }
+
+            // Set minimum frame delay to 100ms for smoother playback
+            // (many GIFs have very small frame delays that would be unplayable)
+            this.Player.SetMinFrameDelayMs(100);
         }

         /// <summary>
--
2.49.0
