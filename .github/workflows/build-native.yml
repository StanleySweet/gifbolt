name: Build Native Libraries

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    strategy:
      matrix:
        arch: [x64, Win32]
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup CMake
        uses: lukka/get-cmake@latest

      - name: Configure CMake
        run: |
          cmake -B build -G "Visual Studio 17 2022" -A ${{ matrix.arch }} -DCMAKE_BUILD_TYPE=Release

      - name: Build
        run: cmake --build build --config Release --target GifBolt.Native

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: native-win-${{ matrix.arch == 'Win32' && 'x86' || 'x64' }}
          path: build/src/GifBolt.Native/Release/GifBolt.Native.dll
          retention-days: 30

  build-macos:
    runs-on: macos-latest
    strategy:
      matrix:
        arch: [x86_64, arm64]
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup CMake
        uses: lukka/get-cmake@latest

      - name: Configure CMake
        run: |
          cmake -B build \
            -DCMAKE_OSX_ARCHITECTURES=${{ matrix.arch }} \
            -DCMAKE_BUILD_TYPE=Release

      - name: Build
        run: cmake --build build --config Release --target GifBolt.Native

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: native-osx-${{ matrix.arch == 'x86_64' && 'x64' || 'arm64' }}
          path: build/src/GifBolt.Native/libGifBolt.Native.dylib
          retention-days: 30

  # build-linux:
  #   runs-on: ubuntu-latest
  #   steps:
  #     - uses: actions/checkout@v4
  #       with:
  #         submodules: recursive
  #
  #     - name: Install dependencies
  #       run: |
  #         sudo apt-get update
  #         sudo apt-get install -y cmake build-essential
  #
  #     - name: Configure CMake
  #       run: cmake -B build -DCMAKE_BUILD_TYPE=Release
  #
  #     - name: Build
  #       run: cmake --build build --target GifBolt.Native
  #
  #     - name: Upload artifact
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: native-linux-x64
  #         path: build/src/GifBolt.Native/libGifBolt.Native.so
  #         retention-days: 30
  # TODO: Enable Linux build once a backend (Vulkan/OpenGL) is implemented

  package-nuget:
    needs: [build-windows, build-macos]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '6.0.x'

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Organize native binaries
        run: |
          mkdir -p src/GifBolt.Core/runtimes/win-x64/native
          mkdir -p src/GifBolt.Core/runtimes/win-x86/native
          mkdir -p src/GifBolt.Core/runtimes/osx-x64/native
          mkdir -p src/GifBolt.Core/runtimes/osx-arm64/native

          cp artifacts/native-win-x64/GifBolt.Native.dll src/GifBolt.Core/runtimes/win-x64/native/
          cp artifacts/native-win-x86/GifBolt.Native.dll src/GifBolt.Core/runtimes/win-x86/native/
          cp artifacts/native-osx-x64/libGifBolt.Native.dylib src/GifBolt.Core/runtimes/osx-x64/native/
          cp artifacts/native-osx-arm64/libGifBolt.Native.dylib src/GifBolt.Core/runtimes/osx-arm64/native/

      - name: Pack NuGet package
        run: |
          cd src/GifBolt.Core
          dotnet pack -c Release -o ../../nupkg /p:Version=1.0.${{ github.run_number }}

      - name: Upload NuGet package artifact
        uses: actions/upload-artifact@v4
        with:
          name: nuget-package
          path: nupkg/*.nupkg
          retention-days: 30

      - name: Upload symbols package artifact
        uses: actions/upload-artifact@v4
        with:
          name: nuget-symbols
          path: nupkg/*.snupkg
          retention-days: 30
