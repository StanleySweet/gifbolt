name: Build and Test

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v3

    - name: Setup CMake
      uses: jwlawson/actions-setup-cmake@v1
      with:
        cmake-version: '3.20.x'

    - name: Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: '6.0.x'

    - name: Configure CMake
      run: cmake -B build -S . -DCMAKE_BUILD_TYPE=Release

    - name: Build Native
      run: cmake --build build --config Release

    - name: Run Native Tests
      working-directory: ./build
      run: ctest -C Release --verbose

    - name: Build .NET Core
      run: dotnet build src/GifBolt.Core/GifBolt.Core.csproj -c Release

    - name: Build WPF Library
      run: dotnet build src/GifBolt.Wpf/GifBolt.Wpf.csproj -c Release

    - name: Build Sample App
      run: dotnet build samples/GifBolt.SampleApp/GifBolt.SampleApp.csproj -c Release

  build-macos:
    runs-on: macos-latest

    steps:
    - uses: actions/checkout@v3

    - name: Setup CMake
      uses: jwlawson/actions-setup-cmake@v1
      with:
        cmake-version: '3.20.x'

    - name: Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: '6.0.x'

    - name: Configure CMake
      run: cmake -B build -S . -DCMAKE_BUILD_TYPE=Release

    - name: Build Native
      run: cmake --build build --config Release -j

    - name: Run Native Tests
      working-directory: ./build
      run: ctest -V

    - name: Build .NET Core
      run: dotnet build src/GifBolt.Core/GifBolt.Core.csproj -c Release

  clang-tidy:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3
      with:
        submodules: recursive

    - name: Install clang-tidy
      run: sudo apt-get install -y clang-tidy

    - name: Run clang-tidy
      run: |
        find src -name "*.cpp" -o -name "*.h" | xargs clang-tidy -checks=-*,readability-*,performance-*,bugprone-* --warnings-as-errors

  format-check:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Install clang-format
      run: sudo apt-get install -y clang-format

    - name: Check code formatting
      run: |
        find src tests -name "*.cpp" -o -name "*.h" | xargs clang-format --dry-run --Werror
